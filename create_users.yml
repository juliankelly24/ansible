---
- hosts: localhost
  user: root

  tasks:
  - include_vars: users.yml
  
  - name: upgrade all packages
    yum: name=* state=latest
    
  - file:
    path: /opt/aaf/x
    state: directory
    mode: 0755 
    
  - copy: Copy Cron.sh
    src: /opt/aaf/repo/config.sh
    dest: /opt/aaf/x/cron.sh
    state: hard
    mode: 0755

  - name: Add users | create users, shell, home dirs
    user: name={{ item.username }} shell=/bin/bash createhome=yes comment='create with ansible'
    with_items: '{{users}}'

  - name: Setup | authorized key upload
    authorized_key: user={{ item.username }}
      key="{{ lookup('file', 'pub_keys/{{ item.username }}.pub') }}"
#      path='/home/{{ item.username }}/.ssh/authorized_keys'
#      manage_dir=no
    with_items: '{{users}}'

  - name: Sudoers | update sudoers file and validate
    lineinfile: "dest=/etc/sudoers
      insertafter=EOF
      line='{{ item.username }} ALL=(ALL) NOPASSWD: ALL'
      regexp='^{{ item.username }} .*'
      state=present"
    when: 'item.use_sudo == True'
    with_items: '{{users}}'
 

